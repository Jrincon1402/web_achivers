name: Deploy to Netlify

on:
  workflow_run:
    workflows: ["CI - Validaciones y Tests"]
    types:
      - completed
    branches: [main, master, develop]
  push:
    branches: [main, master, develop]
    # El workflow_run solo despliega si el CI pasÃ³ exitosamente
    # El push despliega directamente (puedes cambiarlo segÃºn tus preferencias)

jobs:
  deploy:
    name: Desplegar a Netlify
    runs-on: ubuntu-latest
    # Solo despliega si el CI pasÃ³ exitosamente cuando se ejecuta desde workflow_run
    # O si es un push directo a la rama principal
    if: ${{ github.event.workflow_run.conclusion == 'success' || (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')) }}
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Build del proyecto
        run: npm run build

      - name: Instalar Netlify CLI
        run: npm install -g netlify-cli

      - name: Desplegar a Netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          # Si NETLIFY_SITE_ID no estÃ¡ configurado, crear el sitio automÃ¡ticamente
          if [ -z "$NETLIFY_SITE_ID" ]; then
            echo "âš ï¸  NETLIFY_SITE_ID no configurado. Creando sitio automÃ¡ticamente..."
            SITE_INFO=$(netlify sites:create --name "${{ github.event.repository.name }}" --json)
            NETLIFY_SITE_ID=$(echo $SITE_INFO | grep -o '"site_id":"[^"]*"' | cut -d'"' -f4)
            echo "âœ… Sitio creado con ID: $NETLIFY_SITE_ID"
            echo "âš ï¸  IMPORTANTE: Agrega este Site ID como secret NETLIFY_SITE_ID en GitHub para futuros deploys"
            echo "ðŸ“‹ Ve a: Settings > Secrets and variables > Actions y agrega NETLIFY_SITE_ID = $NETLIFY_SITE_ID"
          fi
          
          # Desplegar a producciÃ³n
          netlify deploy --prod --site-id="$NETLIFY_SITE_ID" --message="Deploy desde GitHub Actions: ${{ github.sha }}"
          echo "âœ… Despliegue completado exitosamente"

